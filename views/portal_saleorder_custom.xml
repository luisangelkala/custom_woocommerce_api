<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <template id="sale_order_portal_content_inherit_custom" inherit_id="sale.sale_order_portal_content">

    <xpath expr="//section[@id='details']" position="before">
      <style>
        /* Ocultar columna de impuestos */
        #sales_order_table th#taxes_header,
        #sales_order_table td#taxes,
        #sales_order_table th.text-end[name='th_taxes'],
        #sales_order_table td.text-end[name='td_taxes'] {
          display: none !important;
        }
      </style>
    </xpath>

    <xpath expr="//table[@id='sales_order_table']" position="after">
        <script type="text/javascript">
            document.addEventListener('DOMContentLoaded', function () {
                var table = document.getElementById('sales_order_table');
                if (!table) return;

                // 1. Renombrar columna de Precio Unitario -> "Monthly Quote"
                // Buscamos el segundo TH numérico (el 1ro es Qty)
                var thPrice = table.querySelectorAll('thead th.text-end')[1]; 
                if (thPrice) thPrice.textContent = 'Monthly Quote';

                // 2. Renombrar columna de Descuento -> "Disc. (%)"
                // Buscamos por texto o posición (usualmente está después del precio)
                // Odoo a veces pone la clase d-none d-md-table-cell, la forzamos a mostrarse
                var thDisc = table.querySelector('thead th[title="Discount"]');
                if (!thDisc) {
                     // Si no lo encuentra por title, busca el 3er numérico
                     thDisc = table.querySelectorAll('thead th.text-end')[2]; 
                }
                if (thDisc) {
                    thDisc.textContent = 'Disc. (%)';
                    thDisc.style.display = 'table-cell'; // Forzar visibilidad
                }

                // 3. Renombrar columna de Subtotal -> "Unit Price"
                // Buscamos el último TH numérico
                var thAmount = table.querySelector('thead th.text-end:last-child');
                if (!thAmount) {
                     var allTh = table.querySelectorAll('thead th.text-end');
                     thAmount = allTh[allTh.length - 1];
                }
                if (thAmount) thAmount.textContent = 'Unit Price';
            });
        </script>
    </xpath>


    <xpath expr="//table[@id='sales_order_table']//*[@t-field='line.price_unit']" position="replace">
         <span t-field="line.price_quote"
               t-options='{"widget": "monetary", "display_currency": sale_order.currency_id}'/>
    </xpath>

    <xpath expr="//table[@id='sales_order_table']//tbody//td[contains(@class, 'text-end')][contains(., '%') or @groups]" position="replace">
        <td class="text-end">
            <span t-field="line.discount_price"/>
        </td>
    </xpath>
    <xpath expr="//table[@id='sales_order_table']//thead//th[contains(., 'Disc')]" position="replace">
         <th class="text-end">Disc. (%)</th>
    </xpath>


    <xpath expr="//table[@id='sales_order_table']//*[@t-field='line.price_subtotal']" position="replace">
         <t t-if="line.effective_price_quote > 0">
            <span t-field="line.effective_price_quote"
                  t-options='{"widget": "monetary", "display_currency": sale_order.currency_id}'/>
         </t>
         <t t-else="">
            <span t-field="line.price_subtotal"
                  t-options='{"widget": "monetary", "display_currency": sale_order.currency_id}'/>
         </t>
    </xpath>


    <xpath expr="//div[@id='total']//div[contains(@class,'ms-auto')]" position="inside">
      <hr/>
      <div class="d-flex justify-content-between mb-1">
        <span>TVA (20%):</span>
        <span t-field="sale_order.amount_vat_20" t-options='{"widget": "monetary", "display_currency": sale_order.currency_id}'/>
      </div>
      <div class="d-flex justify-content-between font-weight-bold">
        <span>Total TTC:</span>
        <strong t-field="sale_order.amount_total_incl_vat_20" t-options='{"widget": "monetary", "display_currency": sale_order.currency_id}'/>
      </div>
    </xpath>

  </template>
</odoo>